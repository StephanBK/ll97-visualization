<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NYC LL97 Building Fines - Complete Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { 
      margin:0; padding:0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* Loading Screen */
    #loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      color: #00ffff;
      font-size: 18px;
      backdrop-filter: blur(10px);
    }

    .loading-content {
      text-align: center;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(0, 255, 255, 0.3);
      border-top: 3px solid #00ffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-progress {
      margin-top: 10px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Glassmorphism Controls Panel */
    #controls{
      position:absolute; top:20px; left:20px; z-index:1; width:380px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 0.5px rgba(255, 255, 255, 0.1);
      color: #fff;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    #controls h2{ 
      margin:0 0 20px 0; 
      color:#00ffff; 
      font-weight: 700;
      font-size: 28px;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
      background: linear-gradient(135deg, #00ffff, #0099ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .period-button{
      display:block; width:100%; padding:14px; margin:8px 0; border-radius:12px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color:#fff; border:1px solid rgba(0, 255, 255, 0.3); 
      cursor:pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    .period-button:before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .period-button:hover{ 
      background: rgba(0, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 255, 255, 0.3);
    }
    
    .period-button:hover:before {
      left: 100%;
    }
    
    .period-button.active{ 
      background: rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      border-color: #00ffff;
    }

    /* Coverage Info */
    #coverage-info {
      margin: 20px 0;
      padding: 16px;
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid rgba(0, 255, 0, 0.3);
      border-radius: 12px;
      font-size: 13px;
    }

    #coverage-info h4 {
      margin: 0 0 8px 0;
      color: #00ff00;
      font-size: 14px;
    }

    /* View Mode Toggle */
    #view-mode {
      margin: 20px 0;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    #view-mode h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #00ffff;
      font-weight: 600;
    }

    .view-button {
      display: inline-block;
      padding: 8px 16px;
      margin: 4px 8px 4px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .view-button.active {
      background: rgba(0, 255, 255, 0.3);
      border-color: #00ffff;
    }

    .view-button:hover {
      background: rgba(0, 255, 255, 0.2);
    }

    /* Search and Filter */
    #property-search {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }

    #property-search::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    #type-filter{
      margin-top:20px; padding-top:20px; 
      border-top:1px solid rgba(255, 255, 255, 0.2); 
      max-height:200px; overflow:auto;
    }
    
    #type-filter h3{ 
      margin:0 0 12px 0; font-size:16px; color:#00ffff; 
      font-weight: 600;
    }
    
    .checkbox-row{ 
      display:flex; align-items:center; justify-content: space-between;
      margin:6px 0; font-size:13px; 
      transition: all 0.2s ease;
      padding: 4px;
      border-radius: 4px;
    }
    
    .checkbox-row:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(4px);
    }
    
    .checkbox-row input{ margin-right:10px; }

    .type-count {
      color: rgba(255, 255, 255, 0.6);
      font-size: 11px;
      font-weight: 500;
    }

    /* Enhanced Statistics */
    #stats{ 
      margin-top:20px; padding-top:20px; 
      border-top:1px solid rgba(255, 255, 255, 0.2); 
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .stat-card.full-width {
      grid-column: 1 / -1;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 255, 255, 0.15);
    }
    
    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #00ffff;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
      transition: all 0.3s ease;
    }
    
    .stat-value.large {
      font-size: 24px;
    }
    
    .stat-value.danger {
      color: #ff6b6b;
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.4);
    }

    .stat-value.warning {
      color: #ffa500;
      text-shadow: 0 0 10px rgba(255, 165, 0, 0.4);
    }

    /* Compliance Breakdown */
    .compliance-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .compliance-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
      border-radius: 4px;
      transition: width 0.8s ease;
    }

    /* Glassmorphism Legend */
    #legend{
      position:absolute; right:20px; bottom:30px; z-index:1;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color:#fff; padding:20px; border-radius:16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .legend-title{ 
      color:#00ffff; margin-bottom:16px; font-weight: 600; font-size: 16px;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    
    .legend-item{ 
      display:flex; align-items:center; margin:10px 0; font-size:13px; 
      transition: all 0.2s ease;
    }
    
    .legend-item:hover {
      transform: translateX(4px);
    }
    
    .legend-color{ 
      width:24px; height:24px; margin-right:12px; 
      border:1px solid rgba(255, 255, 255, 0.3); 
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Enhanced Popups */
    .mapboxgl-popup-content{
      background: rgba(0, 0, 0, 0.9) !important; 
      backdrop-filter: blur(20px) !important;
      color:#fff !important; 
      border:1px solid rgba(0, 255, 255, 0.4) !important;
      border-radius:16px !important; 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5) !important;
      padding:20px !important;
      max-width: 300px !important;
    }
    
    .mapboxgl-popup-close-button{ 
      color:#fff !important; font-size:22px !important; 
    }
    
    .popup-title{ 
      color:#00ffff; font-weight:600; margin-bottom:10px; 
      border-bottom:1px solid rgba(0, 255, 255, 0.3); 
      padding-bottom:8px; font-size: 16px;
    }
    
    .popup-fine{ 
      font-size:20px; color:#ff6b6b; font-weight:700; margin:12px 0; 
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }

    .popup-details {
      margin: 12px 0;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .popup-stat {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 12px;
    }

    .popup-stat-label {
      color: rgba(255, 255, 255, 0.7);
    }

    .popup-stat-value {
      color: #00ffff;
      font-weight: 600;
    }
    
    .small{ font-size:12px; color:#aaa; line-height: 1.4; }

    /* Particle System */
    .particle {
      position: absolute;
      pointer-events: none;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 107, 107, 0.8) 0%, rgba(255, 107, 107, 0) 70%);
      animation: particle-float 3s infinite linear;
      z-index: 5;
    }

    @keyframes particle-float {
      0% {
        transform: translateY(0) scale(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) scale(1);
        opacity: 0;
      }
    }

    /* Pulsing Animation for High Fines */
    @keyframes highFinePulse {
      0%, 100% { 
        filter: brightness(1) drop-shadow(0 0 5px rgba(255, 107, 107, 0.5));
        opacity: 0.95;
      }
      50% { 
        filter: brightness(1.4) drop-shadow(0 0 25px rgba(255, 107, 107, 0.9));
        opacity: 1;
      }
    }

    /* Counter Animation */
    @keyframes countUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .counting {
      animation: countUp 0.6s ease-out;
    }

    /* Shimmer effect */
    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: calc(200px + 100%) 0; }
    }

    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      background-size: 200px 100%;
      animation: shimmer 2s infinite;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #controls {
        width: calc(100vw - 40px);
        max-width: 380px;
      }
      
      #legend {
        bottom: 20px;
        right: 20px;
        width: calc(100vw - 40px);
        max-width: 200px;
      }
    }
  </style>
</head>
<body>

<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div id="loading-text">Loading CSV data...</div>
    <div class="loading-progress" id="loading-progress">Preparing visualization</div>
  </div>
</div>

<div id="map"></div>

<div id="controls">
  <h2>NYC LL97 Fines</h2>
  
  <div id="coverage-info">
    <h4>✅ Complete Coverage</h4>
    <div>All 24,891 buildings loaded</div>
    <div class="small">3D buildings + enhanced visual effects</div>
  </div>

  <div>
    <button class="period-button active" data-period="Fine_2024-2029">
      2024–2029 Fines
    </button>
    <button class="period-button" data-period="Fine_2030-2034">
      2030–2034 Fines
    </button>
    <button class="period-button" data-period="Fine_2035-2039">
      2035–2039 Fines
    </button>
  </div>

  <div id="view-mode">
    <h3>View Mode</h3>
    <button class="view-button active" data-view="fine">Fine Amount</button>
    <button class="view-button" data-view="compliance">Compliance</button>
    <button class="view-button" data-view="eui">Energy Intensity</button>
    <button class="view-button" data-view="year">Year Built</button>
  </div>

  <input type="text" id="property-search" placeholder="Search buildings by name or address...">

  <div id="type-filter">
    <h3>Filter by Property Type</h3>
    <div id="type-checkboxes">Loading property types...</div>
  </div>

  <div id="stats">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Buildings Visible</div>
        <div class="stat-value" id="building-count">24,891</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Compliance Rate</div>
        <div class="stat-value" id="compliance-rate">0%</div>
      </div>
    </div>
    
    <div class="stat-card full-width">
      <div class="stat-label">Total Fines</div>
      <div class="stat-value large" id="total-fines">$0</div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Max Fine</div>
        <div class="stat-value danger" id="max-fine">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Major Violators</div>
        <div class="stat-value danger" id="major-violators">0</div>
      </div>
    </div>
    
    <div class="stat-card full-width">
      <div class="stat-label">Average Fine</div>
      <div class="stat-value" id="avg-fine">$0</div>
      <div class="compliance-bar">
        <div class="compliance-fill" id="compliance-fill" style="width: 0%"></div>
      </div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Zero Fines</div>
        <div class="stat-value" id="zero-fines">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">High Risk (>$100k)</div>
        <div class="stat-value danger" id="high-risk">0</div>
      </div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Median Fine</div>
        <div class="stat-value warning" id="median-fine">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Office Buildings</div>
        <div class="stat-value" id="office-count">0</div>
      </div>
    </div>
  </div>
</div>

<div id="legend">
  <div class="legend-title">Fine Amount</div>
  <div class="legend-item">
    <div class="legend-color" style="background:#00ff00;"></div>
    <span>$0 (Compliant)</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background:#88ff00;"></div>
    <span>$1 – $9,999</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background:#ffff00;"></div>
    <span>$10k – $49,999</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background:#ff8800;"></div>
    <span>$50k – $99,999</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background:#ff0000;"></div>
    <span>$100k – $499k</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background:#ff0066; box-shadow: 0 0 15px rgba(255, 107, 107, 0.7);"></div>
    <span>$500k+ (Pulsing)</span>
  </div>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1Ijoic3RlcGhhbmJrIiwiYSI6ImNtZWJtM2VxMTBmZzYyanB6OW9rZmthdWgifQ.WBh_afE2E_ymT0CW48cjMA';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-73.9808, 40.7579],
    zoom: 16,
    pitch: 65,
    bearing: -20,
    antialias: true
  });

  let buildingsData = [];
  let currentPeriod = 'Fine_2024-2029';
  let currentView = 'fine';
  let particleSystem = [];
  let searchQuery = '';

  const TYPE_COLUMN = 'Primary Property Type - Self Selected';
  const paintedFeatureIds = new Set();
  let allowedTypes = new Set();

  // Enhanced color scale with $500k+ threshold
  function getFineColor(fine) {
    if (fine === 0) return '#00ff00';
    if (fine < 10000) return '#88ff00';
    if (fine < 50000) return '#ffff00';
    if (fine < 100000) return '#ff8800';
    if (fine < 500000) return '#ff0000';
    return '#ff0066'; // Special color for $500k+
  }

  function getComplianceColor(fine) {
    return fine === 0 ? '#00ff00' : '#ff0000';
  }

  function getEUIColor(eui) {
    if (!eui || eui === 'Not Available') return '#595959';
    const val = parseFloat(eui);
    if (val < 50) return '#00ff00';
    if (val < 100) return '#88ff00';
    if (val < 150) return '#ffff00';
    if (val < 200) return '#ff8800';
    return '#ff0000';
  }

  function getYearColor(year) {
    if (!year) return '#595959';
    const val = parseInt(year);
    if (val >= 2000) return '#00ff00';
    if (val >= 1980) return '#88ff00';
    if (val >= 1960) return '#ffff00';
    if (val >= 1940) return '#ff8800';
    return '#ff0000';
  }

  // Simplified color expression that actually works
  function fineColorExpression() {
    return [
      'case',
      ['==', ['feature-state', 'fine'], null], '#595959',
      ['step',
        ['feature-state', 'fine'],
        '#00ff00', // 0
        1, '#88ff00',
        10000, '#ffff00',
        50000, '#ff8800',
        100000, '#ff0000',
        500000, '#ff0066'
      ]
    ];
  }

  // Animated number counter
  function animateCounter(element, start, end, duration = 1000) {
    element.classList.add('counting');
    const startTime = performance.now();
    const startValue = start;
    const endValue = end;
    
    function updateCounter(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Easing function for smooth animation
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);
      
      const currentValue = Math.round(startValue + (endValue - startValue) * easeOutQuart);
      
      if (element.id === 'total-fines' || element.id === 'max-fine' || element.id === 'avg-fine' || element.id === 'median-fine') {
        element.textContent = '$' + currentValue.toLocaleString();
      } else if (element.id === 'compliance-rate') {
        element.textContent = currentValue + '%';
      } else {
        element.textContent = currentValue.toLocaleString();
      }
      
      if (progress < 1) {
        requestAnimationFrame(updateCounter);
      } else {
        element.classList.remove('counting');
      }
    }
    
    requestAnimationFrame(updateCounter);
  }

  // Particle system for major violators
  function createParticles(lng, lat, fineAmount) {
    if (fineAmount < 500000) return;
    
    const point = map.project([lng, lat]);
    const mapContainer = map.getContainer();
    
    for (let i = 0; i < 3; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = (point.x - 4) + 'px';
        particle.style.top = (point.y - 4) + 'px';
        particle.style.width = '8px';
        particle.style.height = '8px';
        
        mapContainer.appendChild(particle);
        
        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, 3000);
      }, i * 1000);
    }
  }

  function fmtDollars(n){
    const v = Math.round(Number(n) || 0);
    return '$' + v.toLocaleString();
  }

  // CSV parser
  function parseCSV(text){
    const rows = [];
    let i=0, field='', inQuotes=false, row=[];
    const pushField=()=>{ row.push(field); field=''; };
    while(i<text.length){
      const c=text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field+='"'; i++; }
          else{ inQuotes=false; }
        } else { field += c; }
      } else {
        if(c === '"'){ inQuotes=true; }
        else if(c === ','){ pushField(); }
        else if(c === '\n' || c === '\r'){
          if(field !== '' || row.length){ pushField(); rows.push(row); row=[]; }
          if(c === '\r' && text[i+1] === '\n') i++;
        } else { field += c; }
      }
      i++;
    }
    if(field !== '' || row.length){ pushField(); rows.push(row); }
    const headers = rows.shift().map(h => h.trim());
    const data = [];
    for(const r of rows){
      if(!r.length || r.every(v => (v??'').trim() === '')) continue;
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (r[idx] ?? '').trim());
      if(obj['Latitude'] && obj['Longitude']) data.push(obj);
    }
    return {headers, data};
  }

  // Enhanced statistics with detailed analytics
  function updateStats(){
    const active = buildingsData.filter(b => {
      const typeMatch = allowedTypes.size === 0 || allowedTypes.has(b[TYPE_COLUMN]);
      const searchMatch = !searchQuery || 
        (b['Property Name'] && b['Property Name'].toLowerCase().includes(searchQuery.toLowerCase())) ||
        (b['Address 1'] && b['Address 1'].toLowerCase().includes(searchQuery.toLowerCase()));
      return typeMatch && searchMatch;
    });
    
    const count = active.length;
    let total=0, max=0, majorViolators=0, zeroFines=0, highRisk=0, officeCount=0;
    const fines = [];
    
    active.forEach(b=>{
      const fine = Math.round(parseFloat(b[currentPeriod]) || 0);
      fines.push(fine);
      total += fine;
      if(fine > max) max = fine;
      if(fine >= 500000) majorViolators++;
      if(fine === 0) zeroFines++;
      if(fine >= 100000) highRisk++;
      if(b[TYPE_COLUMN] && b[TYPE_COLUMN].toLowerCase().includes('office')) officeCount++;
    });

    const avgFine = count > 0 ? Math.round(total / count) : 0;
    const complianceRate = count > 0 ? Math.round((zeroFines / count) * 100) : 0;
    
    // Calculate median
    fines.sort((a, b) => a - b);
    const median = fines.length > 0 ? fines[Math.floor(fines.length / 2)] : 0;

    // Get current values for smooth animation
    const currentCount = parseInt(document.getElementById('building-count').textContent.replace(/,/g, '')) || 0;
    const currentTotal = parseInt(document.getElementById('total-fines').textContent.replace(/[$,]/g, '')) || 0;
    const currentMax = parseInt(document.getElementById('max-fine').textContent.replace(/[$,]/g, '')) || 0;
    const currentMajor = parseInt(document.getElementById('major-violators').textContent.replace(/,/g, '')) || 0;
    const currentAvg = parseInt(document.getElementById('avg-fine').textContent.replace(/[$,]/g, '')) || 0;
    const currentZero = parseInt(document.getElementById('zero-fines').textContent.replace(/,/g, '')) || 0;
    const currentHigh = parseInt(document.getElementById('high-risk').textContent.replace(/,/g, '')) || 0;
    const currentCompliance = parseInt(document.getElementById('compliance-rate').textContent.replace(/%/g, '')) || 0;
    const currentMedian = parseInt(document.getElementById('median-fine').textContent.replace(/[$,]/g, '')) || 0;
    const currentOffice = parseInt(document.getElementById('office-count').textContent.replace(/,/g, '')) || 0;

    // Animate counters
    animateCounter(document.getElementById('building-count'), currentCount, count);
    animateCounter(document.getElementById('total-fines'), currentTotal, total);
    animateCounter(document.getElementById('max-fine'), currentMax, max);
    animateCounter(document.getElementById('major-violators'), currentMajor, majorViolators);
    animateCounter(document.getElementById('avg-fine'), currentAvg, avgFine);
    animateCounter(document.getElementById('zero-fines'), currentZero, zeroFines);
    animateCounter(document.getElementById('high-risk'), currentHigh, highRisk);
    animateCounter(document.getElementById('median-fine'), currentMedian, median);
    animateCounter(document.getElementById('office-count'), currentOffice, officeCount);
    animatePercentageCounter(document.getElementById('compliance-rate'), currentCompliance, complianceRate);
    
    // Animate compliance bar
    setTimeout(() => {
      document.getElementById('compliance-fill').style.width = complianceRate + '%';
    }, 500);
  }

  // Percentage counter animation
  function animatePercentageCounter(element, start, end, duration = 1000) {
    element.classList.add('counting');
    const startTime = performance.now();
    
    function updateCounter(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);
      const currentValue = Math.round(start + (end - start) * easeOutQuart);
      
      element.textContent = currentValue + '%';
      
      if (progress < 1) {
        requestAnimationFrame(updateCounter);
      } else {
        element.classList.remove('counting');
      }
    }
    
    requestAnimationFrame(updateCounter);
  }

  function clearPaintedStates(){
    paintedFeatureIds.forEach(id=>{
      map.removeFeatureState({ source:'composite', sourceLayer:'building', id });
    });
    paintedFeatureIds.clear();
  }

  function getActiveTypesFromUI(){
    const boxes = document.querySelectorAll('.type-box');
    const selected = new Set();
    boxes.forEach(b => { if(b.checked) selected.add(b.value); });
    return selected;
  }

  function buildTypeCheckboxes(uniqueTypes){
    const wrap = document.getElementById('type-checkboxes');
    wrap.innerHTML = '';
    
    // Count buildings per type
    const typeCounts = {};
    buildingsData.forEach(b => {
      const type = b[TYPE_COLUMN];
      typeCounts[type] = (typeCounts[type] || 0) + 1;
    });
    
    uniqueTypes.sort((a,b) => (typeCounts[b] || 0) - (typeCounts[a] || 0)); // Sort by count descending
    
    uniqueTypes.forEach(type=>{
      const id = 'type_' + type.replace(/\W+/g,'_');
      const count = typeCounts[type] || 0;
      const row = document.createElement('div');
      row.className = 'checkbox-row';
      row.innerHTML = `
        <div style="display: flex; align-items: center;">
          <input type="checkbox" id="${id}" class="type-box" value="${type}" checked>
          <label for="${id}">${type}</label>
        </div>
        <span class="type-count">${count}</span>
      `;
      wrap.appendChild(row);
    });

    allowedTypes = getActiveTypesFromUI();

    wrap.querySelectorAll('.type-box').forEach(box=>{
      box.addEventListener('change', ()=>{
        allowedTypes = getActiveTypesFromUI();
        applyFinesTo3DBuildings();
      });
    });
  }

  // Enhanced building mapping with particles
  function applyFinesTo3DBuildings(){
    if (!map.getLayer('3d-buildings') || buildingsData.length === 0) return;

    clearPaintedStates();

    const candidates = buildingsData.filter(b => {
      const typeMatch = allowedTypes.size === 0 || allowedTypes.has(b[TYPE_COLUMN]);
      const searchMatch = !searchQuery || 
        (b['Property Name'] && b['Property Name'].toLowerCase().includes(searchQuery.toLowerCase())) ||
        (b['Address 1'] && b['Address 1'].toLowerCase().includes(searchQuery.toLowerCase()));
      return typeMatch && searchMatch;
    });
    
    const usedBuildings = new Set();
    let mappedCount = 0;

    candidates.forEach(b=>{
      const lng = parseFloat(b['Longitude']);
      const lat = parseFloat(b['Latitude']);
      if (isNaN(lng) || isNaN(lat)) return;

      const fine = Math.round(parseFloat(b[currentPeriod]) || 0);
      const pt = map.project([lng, lat]);

      const features = map.queryRenderedFeatures(
        [[pt.x - 8, pt.y - 8], [pt.x + 8, pt.y + 8]],
        { layers: ['3d-buildings'] }
      );

      if (features && features.length) {
        const availableBuilding = features.find(f => 
          f && typeof f.id !== 'undefined' && !usedBuildings.has(f.id)
        );

        if (availableBuilding) {
          usedBuildings.add(availableBuilding.id);
          
          map.setFeatureState(
            { source: 'composite', sourceLayer: 'building', id: availableBuilding.id },
            {
              fine: fine,
              _name: b['Property Name'] || b['Address 1'] || '',
              _addr: b['Address 1'] || '',
              _type: b[TYPE_COLUMN] || '',
              _fine2024: Math.round(parseFloat(b['Fine_2024-2029']) || 0),
              _fine2030: Math.round(parseFloat(b['Fine_2030-2034']) || 0),
              _fine2035: Math.round(parseFloat(b['Fine_2035-2039']) || 0),
              _eui: b['Site EUI (kBtu/ft²)'] || '',
              _year: b['Year Built'] || '',
              _gfa: b['Property GFA - Self-Reported (ft²)'] || '',
              _energyStar: b['ENERGY STAR Score'] || '',
              _ghg: b['Total (Location-Based) GHG Emissions (Metric Tons CO2e)'] || ''
            }
          );
          paintedFeatureIds.add(availableBuilding.id);
          mappedCount++;

          // Create particles for major violators
          if (fine >= 500000) {
            setTimeout(() => createParticles(lng, lat, fine), Math.random() * 2000);
          }
        }
      }
    });

    console.log(`Mapped ${mappedCount} buildings with enhanced effects`);
    updateStats();
  }

  // Map setup with enhanced styling
  map.on('load', ()=>{
    map.setFog({
      color: 'rgb(5, 5, 15)',
      'high-color': 'rgb(15, 15, 35)',
      'horizon-blend': 0.4,
      'space-color': 'rgb(2, 2, 10)',
      'star-intensity': 0.6
    });
    
    map.setLight({
      anchor:'viewport',
      color:'#ffffff',
      intensity:0.6,
      position:[1.5, 200, 30]
    });

    // Enhanced 3D buildings with glow effect for $500k+
    map.addLayer({
      id: '3d-buildings',
      source: 'composite',
      'source-layer': 'building',
      filter: ['==', ['get', 'extrude'], 'true'],
      type: 'fill-extrusion',
      minzoom: 15,
      paint: {
        'fill-extrusion-color': fineColorExpression(),
        'fill-extrusion-height': ['get', 'height'],
        'fill-extrusion-base': ['get', 'min_height'],
        'fill-extrusion-opacity': 0.95,
        'fill-extrusion-vertical-gradient': true
      }
    });

    // Glow layer for major violators
    map.addLayer({
      id: 'major-violator-glow',
      source: 'composite',
      'source-layer': 'building',
      filter: ['==', ['get', 'extrude'], 'true'],
      type: 'fill-extrusion',
      minzoom: 15,
      paint: {
        'fill-extrusion-color': [
          'case',
          ['>=', ['feature-state', 'fine'], 500000], 'rgba(255, 107, 107, 0.6)',
          'transparent'
        ],
        'fill-extrusion-height': [
          'case',
          ['>=', ['feature-state', 'fine'], 500000], 
          ['+', ['get', 'height'], 15], // Slightly taller for glow
          ['get', 'height']
        ],
        'fill-extrusion-base': ['get', 'min_height'],
        'fill-extrusion-opacity': [
          'case',
          ['>=', ['feature-state', 'fine'], 500000], 0.4,
          0
        ]
      }
    });

    // Enhanced building outlines with glow
    map.addLayer({
      id: 'building-outline',
      source: 'composite',
      'source-layer': 'building',
      type: 'line',
      minzoom: 15,
      paint: {
        'line-color': [
          'case',
          ['>=', ['feature-state', 'fine'], 500000], '#ff6b6b',
          '#222'
        ],
        'line-width': [
          'case',
          ['>=', ['feature-state', 'fine'], 500000], 2,
          0.3
        ],
        'line-opacity': [
          'case',
          ['>=', ['feature-state', 'fine'], 500000], 0.8,
          0.4
        ],
        'line-blur': [
          'case',
          ['>=', ['feature-state', 'fine'], 500000], 1,
          0
        ]
      }
    });

    // Load CSV data
    loadCSVData();
  });

  // CSV loading
  async function loadCSVData() {
    try {
      updateLoadingText('Loading CSV file...', 'Fetching building data');
      
      const response = await fetch('LL97_cleaned_reduced_columns.csv');
      if (!response.ok) {
        throw new Error(`Failed to load CSV: ${response.status} ${response.statusText}`);
      }
      
      updateLoadingText('Parsing CSV data...', 'Processing building records');
      const csvText = await response.text();
      
      updateLoadingText('Processing buildings...', 'Creating map data');
      const {headers, data} = parseCSV(csvText);
      buildingsData = data;

      const typeSet = new Set();
      buildingsData.forEach(b=>{
        if (b[TYPE_COLUMN]) typeSet.add(b[TYPE_COLUMN]);
      });
      buildTypeCheckboxes(Array.from(typeSet));

      if (map.getZoom() < 15) map.easeTo({ zoom: 16, duration: 600 });

      setTimeout(() => {
        applyFinesTo3DBuildings();
        updateLoadingText('Complete!', 'All buildings loaded');
        setTimeout(() => {
          document.getElementById('loading').style.display = 'none';
        }, 1000);
      }, 500);
      
    } catch (error) {
      console.error('Error loading CSV:', error);
      updateLoadingText('Error', error.message);
    }
  }

  function updateLoadingText(main, sub) {
    document.getElementById('loading-text').textContent = main;
    document.getElementById('loading-progress').textContent = sub;
  }

  // Period switching with enhanced effects
  document.querySelectorAll('.period-button').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      document.querySelectorAll('.period-button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      currentPeriod = e.target.dataset.period;
      
      // Add transition effect
      document.getElementById('stats').style.opacity = '0.5';
      setTimeout(() => {
        applyFinesTo3DBuildings();
        document.getElementById('stats').style.opacity = '1';
      }, 150);
    });
  });

  // View mode switching
  document.querySelectorAll('.view-button').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      document.querySelectorAll('.view-button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      currentView = e.target.dataset.view;
      
      // Update legend title based on view mode
      const legendTitle = document.querySelector('.legend-title');
      switch(currentView) {
        case 'compliance':
          legendTitle.textContent = 'Compliance Status';
          break;
        case 'eui':
          legendTitle.textContent = 'Energy Use Intensity';
          break;
        case 'year':
          legendTitle.textContent = 'Year Built';
          break;
        default:
          legendTitle.textContent = 'Fine Amount';
      }
      
      applyFinesTo3DBuildings();
    });
  });

  // Search functionality
  document.getElementById('property-search').addEventListener('input', (e)=>{
    searchQuery = e.target.value.trim();
    applyFinesTo3DBuildings();
  });

  // Enhanced popup with more details
  const popup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false });

  map.on('mousemove', '3d-buildings', (e)=>{
    map.getCanvas().style.cursor = 'pointer';
    const f = e.features && e.features[0];
    if (!f) return;

    const state = map.getFeatureState({ source:'composite', sourceLayer:'building', id: f.id }) || {};
    const fine = (state.fine == null) ? null : Math.round(state.fine);

    const violatorBadge = fine >= 500000 ? 
      '<div style="background: linear-gradient(45deg, #ff0066, #ff6699); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; text-align: center; margin: 8px 0;">🚨 MAJOR VIOLATOR</div>' : '';

    const energyStarBadge = state._energyStar && state._energyStar !== 'Not Available' ? 
      `<div style="background: linear-gradient(45deg, #00ff00, #88ff00); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; text-align: center; margin: 8px 0;">⭐ ENERGY STAR: ${state._energyStar}</div>` : '';

    const html = `
      <div class="popup-title">${state._name ? state._name : 'Building'}</div>
      <div>${state._addr ? state._addr : ''}</div>
      <div class="small">${state._type ? state._type : ''}</div>
      ${violatorBadge}
      ${energyStarBadge}
      <div class="popup-fine">Fine: ${fine == null ? '—' : fmtDollars(fine)}</div>
      
      <div class="popup-details">
        <div class="popup-stat">
          <span class="popup-stat-label">2024–29:</span>
          <span class="popup-stat-value">${state._fine2024 != null ? fmtDollars(state._fine2024) : '—'}</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-label">2030–34:</span>
          <span class="popup-stat-value">${state._fine2030 != null ? fmtDollars(state._fine2030) : '—'}</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-label">2035–39:</span>
          <span class="popup-stat-value">${state._fine2035 != null ? fmtDollars(state._fine2035) : '—'}</span>
        </div>
      </div>
      
      <div class="popup-details">
        <div class="popup-stat">
          <span class="popup-stat-label">EUI:</span>
          <span class="popup-stat-value">${state._eui ? state._eui + ' kBtu/ft²' : '—'}</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-label">Year Built:</span>
          <span class="popup-stat-value">${state._year || '—'}</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-label">GFA:</span>
          <span class="popup-stat-value">${state._gfa ? parseFloat(state._gfa).toLocaleString() + ' ft²' : '—'}</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-label">GHG Emissions:</span>
          <span class="popup-stat-value">${state._ghg ? parseFloat(state._ghg).toLocaleString() + ' MT CO₂e' : '—'}</span>
        </div>
      </div>
      
      <div class="small" style="margin-top:8px;">
        Height: ${f.properties.height ? Number(f.properties.height).toLocaleString() + ' m' : '—'}
      </div>
    `;
    popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
  });

  map.on('mouseleave', '3d-buildings', ()=>{
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  // Keyboard controls for enhanced navigation
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'r' || e.key === 'R'){
      map.easeTo({ bearing: map.getBearing() + 90, duration: 3000 });
    }
    if (e.key === '1') {
      document.querySelector('[data-period="Fine_2024-2029"]').click();
    }
    if (e.key === '2') {
      document.querySelector('[data-period="Fine_2030-2034"]').click();
    }
    if (e.key === '3') {
      document.querySelector('[data-period="Fine_2035-2039"]').click();
    }
  });

  console.log('🚀 NYC LL97 Visualization initialized');

</script>

</body>
</html>
